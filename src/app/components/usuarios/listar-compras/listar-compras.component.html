<h2 *ngIf="isAdminRole && firebaseAuthenticationReady">VENTAS</h2>
<h2 *ngIf="!isAdminRole && firebaseAuthenticationReady">MIS COMPRAS</h2>
<hr class="hr-subtitulo">

<div class="compras-container">
    
    <aside class="busqueda-aside">
        <div class ="busqueda-aside-box" *ngIf="isAdminRole && firebaseAuthenticationReady">
            <p>BUSCAR:</p>
            <input class="input-pequeno" type="text" [(ngModel)]="datoBuscado" placeholder="Ingrese el numero de compra, dni o email del cliente..." (keydown.enter)="buscarCompras()">
        </div>

         <div class="busqueda-aside-box">
            <p>FILTRAR:</p>
            <select [(ngModel)]="filtroEstado" (change)="filtrarPorEstado()">
                <option value="" hidden>Estado de la compra...</option>
                <option *ngFor="let estado of arrayEstados" [value]="estado">{{estado}}</option>
            </select> 
        </div> 
    
        <div class="busqueda-aside-box">
            <p>RANGO FECHA:</p>
            <div class="aside-fecha">
                <input type="date" [(ngModel)]="fechaDesde" (change)="filtrarPorFecha()">
                <input type="date" [(ngModel)]="fechaHasta" (change)="filtrarPorFecha()">
            </div>
        </div>
        
        <button class="boton-claro" (click)="buscarCompras()">Buscar</button>
    </aside>

    <main class="listado-compras" *ngIf="firebaseAuthenticationReady && isLogged && busqueda">
        <div *ngIf="!existeUsuario">
            <h2 class="error-resultado-busqueda">No se encontro al usuario</h2>
        </div>
        <div *ngIf="!tieneCompras && existeUsuario">
            <h2 class="error-resultado-busqueda">El usuario no ha realizado compras</h2>
        </div>
        <table class="tabla-compras">
            <thead>
                <tr>
                    <th></th>
                    <th>Nro Compra</th>
                    <th>Fecha</th>
                    <th>Productos</th>
                    <th>Total</th>
                    <th>Cliente</th>
                    <th>Estado</th>
                    <th>Acción</th>
                </tr>
            </thead>

            <tbody>
                <tr *ngFor="let compra of compras">
                    <td>
                        <input type="checkbox" name="checkCompra" id="checkCompra"
                             [(ngModel)]="checkCompras[compra.idDoc!]" (change)="actualizarComprasSeleccionadas()">
                    </td>
                    <td>{{compra.idDoc}}</td>
                    <td>{{compra.fecha}}</td> 
                    
                    <td>
                        <a *ngIf="!estadoAmpliacion[compra.idDoc!]" (click)="ampliarCompra(compra.idDoc)">Ampliar</a>
                        <a *ngIf="estadoAmpliacion && estadoAmpliacion[compra.idDoc!]" (click)="ampliarCompra(compra.idDoc)">Reducir</a>
                        <div *ngIf="estadoAmpliacion && estadoAmpliacion[compra.idDoc!]">
                            <div class="producto-cantidad" *ngFor="let producto of compra.items">
                                <p>{{producto.nombre}}</p>
                                <div class="cantidad">
                                    <p> x </p>
                                    <p>{{producto.cantidad}}</p>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>${{compra.total}}</td>
                    <td>{{clientes.get(compra.userId)}}</td>
                    <td>{{compra.estado}}</td>
                    <td>
                        <button *ngIf="compra.estado == 'Pendiente de pago'" 
                            (click)="cambiarEstadoCompra(compra.idDoc!, 'Pago confirmado')">Confirmar Pago</button>
                        <button *ngIf="compra.estado == 'Pago confirmado'"
                            (click)="cambiarEstadoCompra(compra.idDoc!, 'Pedido empaquetado')">Empaquetar pedido</button>
                        <button *ngIf="compra.estado == 'Pedido empaquetado'" 
                            (click)="cambiarEstadoCompra(compra.idDoc!, 'Envío notificado')">Notificar envío</button>
                        <button *ngIf="compra.estado == 'Envío notificado'"
                            (click)="cambiarEstadoCompra(compra.idDoc!, 'Pedido entregado')">Entregar pedido</button>
                        <button *ngIf="compra.estado == 'Pedido entregado'"
                            (click)="cambiarEstadoCompra(compra.idDoc!, 'Archivada')">Archivar</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </main>

    <div class="selector-compras" *ngIf="hayComprasSeleccionadas()">
        <label>Accionar</label>
        <select [(ngModel)]="accionSeleccionada">
            <option value="Cancelar">Cancelar</option>
            <option value="Archivar">Archivar</option>
        </select>
    </div>
    
</div>


